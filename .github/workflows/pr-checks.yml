name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, dev]
  workflow_dispatch:

env:
  NODE_VERSION: "20"

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-checks:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Check code formatting
        run: yarn format:check

      - name: Verify no uncommitted changes after formatting check
        run: |
          if ! git diff --exit-code; then
            echo "âŒ Code has uncommitted changes after formatting check!"
            echo "Please run 'yarn format' locally and commit the changes."
            echo ""
            echo "Changed files:"
            git diff --name-only
            echo ""
            echo "Detailed changes:"
            git diff
            exit 1
          else
            echo "âœ… Code is properly formatted."
          fi

      - name: Run tests with coverage
        run: yarn test --coverage

      - name: Post coverage summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = summary.total;
            const fmt = (pct) => `${pct.pct.toFixed(1)}%`;
            const body = [
              '## ğŸ“Š Test Coverage',
              '',
              '| Metric | Coverage |',
              '|--------|----------|',
              `| Statements | ${fmt(total.statements)} |`,
              `| Branches | ${fmt(total.branches)} |`,
              `| Functions | ${fmt(total.functions)} |`,
              `| Lines | ${fmt(total.lines)} |`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('## ğŸ“Š Test Coverage'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Build SDK
        run: yarn build

      - name: Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build artifacts not found!"
            exit 1
          fi
          echo "âœ… Build artifacts generated successfully."
          echo "Generated files:"
          ls -la dist/ | head -20
